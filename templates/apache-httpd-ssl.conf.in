# Apache HTTPD config for SSL
# ===========================
#
# Install this in $APACHE_HTTPD_HOME/conf/vhosts-ssl.
#
<VirtualHost ${:local-ip}:443>
    ServerName ${:public-hostname}
    ServerAlias ${:local-hostname}
    ServerAdmin nciweb@mail.nih.gov
    RewriteEngine On
    SSLEngine On
    SSLProtocol all
    SSLCipherSuite HIGH:MEDIUM
    SSLCertificateFile ${buildout:directory}/etc/server.crt
    SSLCertificateKeyFile ${buildout:directory}/etc/server.key

    RewriteCond %{HTTP_HOST} ^${:public-hostname-escaped}$
    RewriteRule ^/(.*)logged_out http://${:public-hostname}/$1logged_out [L,P]

    RewriteCond %{REQUEST_URI} !/snapshots(.*)
    RewriteCond %{REQUEST_URI} !/blobstorage(.*)
    RewriteRule ^(.*) http://${hosts:instance1}:${ports:instance1}/VirtualHostBase/https/${:public-hostname}:443/edrn/VirtualHostRoot$1 [L,P]

    Alias /snapshots "${buildout:directory}/var/snapshotbackups"
    <Directory "${buildout:directory}/var/snapshotbackups">
	    AuthType basic
	    AuthName "Database Snapshots"
        AuthUserFile ${buildout:directory}/etc/snapshots.cfg
        Require valid-user
        Order Deny,Allow
	    Allow from All
	    Options Indexes FollowSymLinks
        AllowOverride none
    </Directory>
    ProxyPass /snapshots !

    Alias /blobstorage ${buildout:directory}/var/blobstorage
    <Directory "${buildout:directory}/var/blobstorage">
        AuthType basic
        AuthName "Database Blobstorage"
        AuthUserFile ${buildout:directory}/etc/snapshots.cfg
        Require valid-user
        Order Deny,Allow
        Allow from All
        Options Indexes
    </Directory>
    ProxyPass /blobstorage !
</VirtualHost>
